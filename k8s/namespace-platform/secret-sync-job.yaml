apiVersion: batch/v1
kind: Job
metadata:
  name: secret-sync-trigger
  namespace: platform
  annotations:
    # This job ensures db-credentials secret is created by mounting SecretProviderClass
    # It's idempotent - safe to run multiple times
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300  # Auto-cleanup after 5 minutes
  template:
    spec:
      serviceAccountName: backend-sa
      restartPolicy: OnFailure
      containers:
      - name: secret-sync
        image: busybox:1.36
        command: ['sh', '-c', 'echo "Triggering secret sync by mounting SecretProviderClass..." && ls -la /mnt/secrets-store/ && echo "Secret sync triggered successfully"']
        volumeMounts:
        - name: secrets-store-inline
          mountPath: "/mnt/secrets-store"
          readOnly: true
        resources:
          requests:
            cpu: "10m"
            memory: "16Mi"
          limits:
            cpu: "50m"
            memory: "32Mi"
      volumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: "db-secret-provider"

